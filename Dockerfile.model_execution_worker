FROM coreoasis/ktools:R_0_0_0_225

ARG USER_ID
WORKDIR /home/worker

COPY ./src/model_execution_worker/requirements.txt /tmp/
RUN pip install -r /tmp/requirements.txt

COPY ./src/oasis_utils/requirements.txt /tmp/
RUN pip install -r /tmp/requirements.txt

COPY ./data/static /var/oasis/model_data/OasisIM/1
COPY ./data/static /var/oasis/model_data/OasisIM/2
COPY ./src/model_execution_worker/startup.sh ./
COPY ./src/common ./common/
COPY ./src/model_execution_worker/ ./model_execution_worker/
COPY ./src/model_execution/ ./model_execution/
COPY ./src/utils/ ./utils/
COPY ./src/oasis_utils/ ./oasis_utils/
COPY ./tests /home/worker/tests

RUN adduser --shell /bin/bash --uid $USER_ID --disabled-password --gecos "" worker && \
    usermod -a -G www-data worker

RUN mkdir -p /var/oasis/working && \
    mkdir -p /var/log/oasis && \
    ln -sf /proc/self/fd/1 /var/log/oasis/worker.log && \
    ln -sf /proc/self/fd/1 /var/log/apache/error.log && \
    ln -sf /proc/self/fd/1 /var/log/apache/access.log


RUN chmod -R 777 /home/worker/common /home/worker && \
    chown -R worker:worker /home/worker && \
    chown -R worker:worker /var/oasis && \
		chown -R worker:worker /var/log && \
		chown -R worker:worker /var/oasis/working

#RUN python /home/worker/tests/KparseTests.py || true

ENTRYPOINT \
	sed -i -e "s/%RABBIT_PORT%/$RABBIT_PORT/" /home/worker/common/CeleryConfig.py && \
	sed -i -e "s/%MYSQL_PORT%/$MYSQL_PORT/" /home/worker/common/CeleryConfig.py && \
	sed -i -e "s/%CELERY_QUEUE%/$MODEL_SUPPLIER_ID-$MODEL_VERSION_ID/" startup.sh && \
	./utils/wait-for-it.sh "oasis_rabbit:$RABBIT_PORT" && \
	./utils/wait-for-it.sh "oasis_mysql:$MYSQL_PORT" && \
	./startup.sh
